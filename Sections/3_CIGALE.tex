\section{Decomposing Galaxy SEDs} \label{Sec: CIGALE}
The public version of the ZFOURGE catalogues has utilised \texttt{EAZY} \citep{brammer_eazy_2008} and \texttt{FAST} \citep{kriek_ultra-deep_2009} for parameterising galaxy properties, primarily focusing on photometric redshifts, stellar masses, and SFRs. However, while effective, these methods provide a more generalised view of galaxy properties without entirely disentangling the contributions from different physical components within each galaxy, such as SF regions and AGN. To address this limitation, we employ the SED fitting software CIGALE \citep{boquien_cigale_2019}, which enables the decomposition of observed light from galaxies into distinct components, including SF and AGN activity. This method builds on the work by \cite{cowley_decoupled_2018}, incorporating additional photometric coverage and an updated parameter space to better quantify AGN contributions.

\subsection{CIGALE Methodology and Parameter Space} \label{Sec: CIGALE_Parameters}
CIGALE performs multi-component SED fitting to derive galaxy properties by integrating our photometry from 0.2 $\mu$m to 160 $\mu$m across the CDFS field and up to 24 $\mu$m for COSMOS and UDS. This broader wavelength coverage allows for a more complete and precise decomposition of galaxy light into SF and AGN components. The decomposition uses a range of parameter values (see Table \ref{tab:parameter_space}), allowing for flexible modelling of star formation histories (SFH), dust attenuation, AGN torus contributions, and other factors. We also incorporate the SKIRTOR AGN torus model \citep{stalevski_dust_2016}, which better handles clumpy dust distributions and polar dust extinction, providing an accurate characterisation of AGN emission.

The ZFOURGE sample has the following photometry: IRAC 3.6$\mu m$ (S/N $\geq$ 1): 98.84\%; MIPS 24$\mu m$ (S/N $\geq$ 1): 69.09\%; and Herschel PACS 70-160$\mu m$ (S/N $\geq$ 1): 11.84\%. With each band increasing to 99.47\%, 100\% and 26.19\% at S/N $\geq$ 0 respectively. 

\subsection{Bolometric IR Luminosity Derivation} \label{Sec: IR_Luminosity}
Understanding the total IR energy output of galaxies is essential for tracing both SF and AGN activity, particularly in dusty environments where much of the energy is re-emitted in the IR \citep{fu_decomposing_2010}. By estimating the bolometric IR luminosity, we can gain insights into the contribution of these processes across cosmic time. 

For the ZFOURGE LF sample, we adopted the approach in \cite{straatman_fourstar_2016} where the averaged \cite{wuyts_fireworks_2008} template was fit to the 24-160 $\mu$m photometry to estimate the total bolometric IR luminosity. However, at $z>3$, we find an offset of 0.27 dex in ZFOURGE luminosity over CIGALE luminosity. This is readily seen in Figure \ref{Fig: LIR vs LIR} (top) as the purple/magenta dots. These sources are also highly AGN-dominated. Because \cite{wuyts_fireworks_2008} only samples the 24-160$\mu m$ range, in conjunction with our dataset hosting only a small fraction of FIR data, our ZFOURGE luminosities at $z>3$ are likely overestimated. To account for this, we add in quadrature to the ZFOURGE $L_{IR}$ an error of 0.27 dex in addition to $z_{phot}$ and $L_{IR}$ errors.

For the CIGALE decomposed SF and AGN LF samples, we derive luminosities through a different approach. CIGALE performs SED decomposition on the entire galaxy emission, using its integrated models to separate the total luminosity into distinct stellar, dust, and AGN components. The stellar and dust luminosities are combined to form the SF component, while the AGN component is derived directly from CIGALE's emission modelling. These distinct approaches are subsequently used to construct the IR luminosity functions of the two samples. 

Figure \ref{Fig: LIR vs LIR} compares the CIGALE decomposed total luminosity to the ZFOURGE total luminosity ($L_{IR}$). In the top panel, galaxies are coloured based on their redshift bin. It can be seen that the brightest galaxies are more likely to exist at higher redshifts. In the bottom panel, galaxies are coloured based on the AGN fraction ($\mathrm{F}_{AGN}$) to the total luminosity derived by CIGALE. Galaxies at higher redshift are brighter and more likely to host a powerful AGN.

\begin{table}[htbp]
    \caption{Parameter space used for SED fitting with CIGALE}
    \label{tab:parameter_space}
    \begin{center}
    \begin{tabular}{ll}
        \toprule
        \textbf{Parameter} & \textbf{Model/Values} \\ 
        \hline
        SFH                 & Delayed SFH $\tau = 1,3,5,7,9,11$ Gyr \\
        Age                 & $0.5, 1, 3, 5, 7, 9, 11$ Gyr \\
        Burst Fraction      & $0.0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.3$ \\
        SSP                 & \cite{bruzual_stellar_2003} \\
        IMF                 & \cite{chabrier_galactic_2003} \\
        Metallicity         & Fixed at 0.02 \\
        Nebular             & \cite{inoue_rest-frame_2011} \\
        Dust Atten.         & \cite{calzetti_dust_2000} $E_{(B-V)} = 0.01, 0.05, 0.1, 0.5$, \\
                            & $1.0, 1.5$ \\
        Dust Emission       & \cite{dale_two-parameter_2014} $\alpha = 1.0, 1.5, 2.0, 2.5, 3.0$ \\
        AGN Model           & SKIRTOR \citep{stalevski_3d_2012, stalevski_dust_2016} \\
        Torus Inclination   & $30^\circ, 70^\circ$ \\
        AGN Fraction        & $0.0, 0.01, 0.1 - 0.9$ (steps of 0.1), 0.99 \\
        Polar Extinction    & SMC $E(B-V) = 0.0, 0.03, 0.1, 0.2, 0.4, 0.6, 1.0, 1.8$ \\
        \botrule
    \end{tabular}
    \end{center}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=0.48\textwidth]{Figures/LIR_vs_LIR.png}
    \caption{ZFOURGE bolometric 8-1000$\mu$m IR luminosity compared to CIGALE total luminosity. Top: Sources coloured by redshift bin. Bottom: sources coloured by AGN fraction ($\mathcal{F}_{AGN}$). AGN fraction increases with redshift. At $z \geq 3$, the average AGN fraction is greater than 30\%.}
    \label{Fig: LIR vs LIR}
\end{figure}

\subsection{Robustness Tests with Mock Analysis} \label{Sec: Mock_Analysis}
To ensure the reliability of the decomposition process, particularly for faint AGN, we performed a series of robustness tests using CIGALE's built-in mock analysis. These tests evaluate the software's ability to accurately decompose AGN and SF contributions across various redshifts and luminosities, specifically focusing on galaxies with low bolometric IR luminosities. By comparing the input and recovered AGN luminosities from the analysis, we confirmed that our parameter space and methodology are robust, particularly in detecting faint AGN. The mock analysis demonstrated that AGN luminosity was reliably constrained, with Pearson correlation coefficients (PCCs) ranging from 0.969 to 0.973 across all fields. Most sources lay within 0.5 dex of the 1-to-1 line, with mean residuals between $-0.02$ and $0.04$ dex, confirming the robustness of AGN luminosity recovery. These results indicate that our method effectively minimises bias against faint AGN, which are often difficult to detect in traditional analyses.

\subsection{Reliability of $L_{IR}$ Estimates Without FIR Constraints} \label{Sec: FIR Constraints}
ZFOURGE provides deep photometric coverage from the UV through near- and mid-infrared, but coverage at far-infrared (FIR) wavelengths, particularly at 160$\mu m$, is limited (Refer to Section \ref{Sec: CIGALE_Parameters}). Herschel PACS photometry is available for only a subset of sources in the CDFS field. To assess how this limitation affects our ability to recover LIR we performed a targeted mock-based validation using CIGALE.

We selected all galaxies with redshift $z > 2.5$ (a total of 6,940 sources) and compared their estimated $L_{IR}$ to the corresponding mock-recovered values provided by CIGALE. This test does not impose a MIPS SNR cut, ensuring that it captures the uncertainty across the full range of constraints available. Restricting the comparison to galaxies within the range $\log_{10}(L_{IR} [W]) \in [34, 40]$, we find:

\begin{itemize}
    \item Mean $\Delta \log L_{IR}$ = 0.004 dex (no systematic bias),
    \item Standard deviation = 0.27 dex,
    \item Normalized median absolute deviation (NMAD) = 0.14 dex
    \item ~19\% of sources show deviations greater than 0.3 dex.
\end{itemize}

These results indicate that CIGALE can recover IR luminosities with quantified and stable accuracy even for high-z sources lacking strong FIR constraints. This provides a quantitative bound on the uncertainty in $L_{IR}$ used throughout the luminosity function analysis. We add an additional error of 0.27 dex in luminosity to all sources at all redshifts and propagate this uncertainty to the luminosity function and beyond.

For a more comprehensive description of the SED decomposition methodology, see \cite{cowley_decoupled_2018}. Additionally, refer to the CIGALE software paper \citep{boquien_cigale_2019} for detailed information on its decomposition process and parameter optimisation techniques.

% \subsection{Bolometric IR Luminosity Derivation}
% \label{sec: Bolometric IR Luminosity}

% Understanding the total IR energy output of galaxies is essential for tracing both SF and AGN activity, particularly in dusty environments where much of the energy is re-emitted in the IR \citep{fu_decomposing_2010}. By estimating the bolometric IR luminosity, we can gain insights into the contribution of these processes across cosmic time. To this end, we integrate the best-fit SED of each source from 8-1000$\mu$m to estimate the bolometric IR luminosity, providing a robust measure of the total IR emission. Specifically, we use the averaged \cite{wuyts_fireworks_2008} template to fit the 24-160$\mu$m photometry, from which the total bolometric IR luminosity is derived. For a detailed description of this calculation, refer to section 6 of \cite{straatman_fourstar_2016}.

% Similarly, the CIGALE stellar and dust luminosity are combined to form the SF component. The CIGALE AGN luminosity forms the AGN component. These luminosities are subsequently used to construct the IR luminosity function of the ZFOURGE survey and CIGALE SF and AGN populations up to $z \approx 6$ (see section \ref{Sec: Luminosity Functions}). It is important to note that individual galaxies can contain both an AGN and SF component luminosity due to mixing. Figure \ref{Fig: SED Example} shows an example of a CIGALE SED and its decomposed components.

% The 24$\mu$m flux is usually a good proxy for the bolometric flux \citep{rodighiero_mid-_2010}. However, when the 24$\mu$m flux limit is used with the ZFOURGE bolometric luminosity, the limit varies with redshift, possibly due to spectral features shifting in and out of the template fitting process. Instead, we calculate the bolometric flux from the bolometric luminosity and take the 80\% completeness as the flux limit. We calculate the ZFOURGE bolometric flux limit to be $3.882\times10^{-18}$ $W/m^2$. The ZFOURGE star-forming and quiescent-dominated sources have very similar flux limits. \textcolor{red}{The CIGALE total and star-forming sources have a flux limit of $5.232\times10^{-18}$ $W/m^2$. The CIGALE AGN flux also varies with redshift, so we calculate the 80\% % completeness for each redshift bin. Additionally, luminosity completeness limits for ZFOURGE and CIGALE are calculated for each redshift bin. These limits represent the minimum luminosity a galaxy must have to be detectable throughout the entire redshift bin.}